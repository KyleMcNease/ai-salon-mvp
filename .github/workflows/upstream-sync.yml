name: Upstream Sync Check

on:
  schedule:
    # Run weekly on Mondays at 9 AM UTC
    - cron: '0 9 * * 1'
  workflow_dispatch:

jobs:
  check-upstream:
    name: Check for upstream updates
    runs-on: ubuntu-latest

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Add upstream remote
        run: |
          git remote add fork-ii https://github.com/Intelligent-Internet/ii-agent.git || true
          git fetch fork-ii main

      - name: Check for new commits
        id: check
        run: |
          CURRENT_PIN=$(grep "Pinned commit:" docs/UPSTREAM.md | awk '{print $3}')
          LATEST_UPSTREAM=$(git ls-remote fork-ii main | awk '{print $1}')

          echo "Current pinned: $CURRENT_PIN"
          echo "Latest upstream: $LATEST_UPSTREAM"

          if [ "$CURRENT_PIN" != "$LATEST_UPSTREAM" ]; then
            echo "needs_sync=true" >> $GITHUB_OUTPUT
            echo "current=$CURRENT_PIN" >> $GITHUB_OUTPUT
            echo "latest=$LATEST_UPSTREAM" >> $GITHUB_OUTPUT
          else
            echo "needs_sync=false" >> $GITHUB_OUTPUT
          fi

      - name: Create issue if out of sync
        if: steps.check.outputs.needs_sync == 'true'
        uses: actions/github-script@v7
        with:
          script: |
            const current = '${{ steps.check.outputs.current }}';
            const latest = '${{ steps.check.outputs.latest }}';

            const title = 'ðŸ“¦ Upstream ii-agent has new commits';
            const body = `## Upstream Sync Needed

            New commits available from [Intelligent-Internet/ii-agent](https://github.com/Intelligent-Internet/ii-agent).

            - **Current pin**: \`${current.substring(0, 8)}\`
            - **Latest upstream**: \`${latest.substring(0, 8)}\`

            ### Action Required
            1. Create branch \`chore/merge-upstream\`
            2. Review changes: https://github.com/Intelligent-Internet/ii-agent/compare/${current.substring(0, 8)}...${latest.substring(0, 8)}
            3. Run \`git subtree pull\` or merge as appropriate
            4. Update \`docs/UPSTREAM.md\` with new pinned commit
            5. Ensure CI tests pass
            6. Open PR with upstream sync changes

            See \`docs/UPSTREAM.md\` for the full pull ritual.`;

            // Check if issue already exists
            const issues = await github.rest.issues.listForRepo({
              owner: context.repo.owner,
              repo: context.repo.repo,
              state: 'open',
              labels: ['upstream-sync']
            });

            if (issues.data.length === 0) {
              await github.rest.issues.create({
                owner: context.repo.owner,
                repo: context.repo.repo,
                title: title,
                body: body,
                labels: ['upstream-sync', 'maintenance']
              });
            }
